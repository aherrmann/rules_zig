load("@bazel_skylib//rules:build_test.bzl", "build_test")
load("@rules_zig//zig:defs.bzl", "zig_configure_test")
load("//zig/private:versions.bzl", "TOOL_VERSIONS")

build_test(
    name = "zig-docs",
    tags = ["manual"],
    target_compatible_with = select({
        # Flaky with older versions see
        # https://github.com/aherrmann/rules_zig/issues/273
        "@zig_toolchains//:0.11.0": ["@platforms//:incompatible"],
        "@zig_toolchains//:0.12.0": ["@platforms//:incompatible"],
        "@zig_toolchains//:0.12.1": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    targets = [
        "//zig/runfiles:docs",
    ],
)

[
    zig_configure_test(
        name = "zig-docs-{}".format(version),
        size = "small",
        actual = ":zig-docs",
        tags = ["zig-docs"],
        zig_version = version,
    )
    for version in TOOL_VERSIONS.keys()
]
